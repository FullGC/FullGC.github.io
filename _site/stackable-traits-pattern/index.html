<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="The FullGC blog. Practical guides for the Backend guy. We speak Scala, Java and DevOps">

    <title>Stackable Traits pattern - Part 1 | Dani</title>

    <link rel="canonical" href="http://fullgc.github.io/stackable-traits-pattern/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- facebook Open Graph Metadatas -->
    <meta content="609039549219229" property="fb:app_id">
    <meta content="FullGC" property="og:site_name">
    
      <meta content="Stackable Traits pattern - Part 1" property="og:title">
    
    
      <meta content="article" property="og:type">
    
    
      <meta content="The FullGC blog. Practical guides for the Backend guy. We speak Scala, Java and DevOps" property="og:description">
    
    
      <meta content="http://fullgc.github.io/stackable-traits-pattern/" property="og:url">
    
    
      <meta content="2018-07-23T17:20:45+03:00" property="article:published_time">
      <meta content="http://fullgc.github.io/about/" property="article:author">
    
    
      <meta content="http://fullgc.github.io/img/burger-stack12.jpg" property="og:image">
    
    
      
    
    
      
      <meta content="scala" property="article:tag">
      
      <meta content="stackable" property="article:tag">
      
      <meta content="traits" property="article:tag">
      
    


    
      <meta name="twitter:url" content="http://fullgc.github.io/stackable-traits-pattern/">
    
    
      <meta name="twitter:description" content="The FullGC blog. Practical guides for the Backend guy. We speak Scala, Java and DevOps">
    
    
      <meta name="twitter:image:src" content="http://fullgc.github.io/img/burger-stack12.jpg">
    

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-57009102-1', 'auto');
  ga('send', 'pageview');

</script>

</head>

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Stackable Traits pattern - Part 1 | FullGC</title>
<meta name="generator" content="Jekyll v3.7.4" />
<meta property="og:title" content="Stackable Traits pattern - Part 1" />
<meta name="author" content="Dani Shemesh" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="This post is the first of a two parts series of articles on Stackable Traits" />
<meta property="og:description" content="This post is the first of a two parts series of articles on Stackable Traits" />
<link rel="canonical" href="http://fullgc.github.io/stackable-traits-pattern/" />
<meta property="og:url" content="http://fullgc.github.io/stackable-traits-pattern/" />
<meta property="og:site_name" content="FullGC" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-07-23T17:20:45+03:00" />
<script type="application/ld+json">
{"description":"This post is the first of a two parts series of articles on Stackable Traits","author":{"@type":"Person","name":"Dani Shemesh"},"@type":"BlogPosting","url":"http://fullgc.github.io/stackable-traits-pattern/","headline":"Stackable Traits pattern - Part 1","dateModified":"2018-07-23T17:20:45+03:00","datePublished":"2018-07-23T17:20:45+03:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://fullgc.github.io/stackable-traits-pattern/"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

<body>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a style="text-shadow:none" class="navbar-brand" href="/">Dani Shemesh</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                
                <li>
                    <a href="/about/">About</a>
                </li>
                
                <li>
                    <a href="/contact/">Contact</a>
                </li>
                
                <li>
                    
                </li>
                
                <li>
                    
                </li>
                
                <li>
                    
                </li>
                
                <li>
                    
                </li>
                
                <li>
                    
                </li>
                
                <li>
                    
                </li>
                
                <li>
                    
                </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>

    <!-- /.container -->
</nav>

    <!-- Post Header -->
<header class="intro-header" style="background-image: url('/img/burger-stack12.jpg')">
    <div class="container">
        <div class="row">

            <div class="col-lg-10 col-lg-offset-1 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>Stackable Traits pattern - Part 1</h1>
                    
                    <span class="meta">Posted by Dani Shemesh on July 23, 2018</span>
                </div>
            </div>
        </div>
    </div>
    <!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Stackable Traits pattern - Part 1 | FullGC</title>
<meta name="generator" content="Jekyll v3.7.4" />
<meta property="og:title" content="Stackable Traits pattern - Part 1" />
<meta name="author" content="Dani Shemesh" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="This post is the first of a two parts series of articles on Stackable Traits" />
<meta property="og:description" content="This post is the first of a two parts series of articles on Stackable Traits" />
<link rel="canonical" href="http://fullgc.github.io/stackable-traits-pattern/" />
<meta property="og:url" content="http://fullgc.github.io/stackable-traits-pattern/" />
<meta property="og:site_name" content="FullGC" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-07-23T17:20:45+03:00" />
<script type="application/ld+json">
{"description":"This post is the first of a two parts series of articles on Stackable Traits","author":{"@type":"Person","name":"Dani Shemesh"},"@type":"BlogPosting","url":"http://fullgc.github.io/stackable-traits-pattern/","headline":"Stackable Traits pattern - Part 1","dateModified":"2018-07-23T17:20:45+03:00","datePublished":"2018-07-23T17:20:45+03:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://fullgc.github.io/stackable-traits-pattern/"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</header>


<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <div class="col-lg-10 col-lg-offset-1 col-md-10 col-md-offset-1">

				      <p><i>This post is the first of a two parts series of articles on Stackable Traits</i></p>

<ul>
  <li><a href="https://fullgc.github.io/stackable-traits-pattern/">Part-1: Error reporting design with Stackable Traits</a></li>
  <li><a href="https://fullgc.github.io/stackable-traits-pattern---part-2/">Part-2: Gathering Metrics with Stackable Actors</a></li>
</ul>

<hr />

<p><em>“Traits let you modify the methods of a class, and they do so in a way that allows you to stack those modifications with each other” (Programming in Scala by Martin Odersky)</em></p>

<p>One of the reasons that Scala still feels to me like ‘a better Java’, is the power of its traits. A trait can be used for multiple inheritances, a Java interface, a rich interface with fields and a state, and a mix into a class.</p>

<p>An interesting behavior of traits, as opposed to classes, is the call for a super method. In classes this is statically bound, meaning that the exact implementation to be invoked is known upfront. In traits however, this is dynamically bound.
The term usually refers to an invocation of a method in an object, where the implementation is decided at runtime, i.e. a polymorphic call. The super call is not defined when a trait is defined, but only when it is mixed into a concrete class.
Such behavior allows us to ‘stack’ the traits, and use the super call as a ‘pipe’, redirecting output - similar to the ‘pipe’ in Linux. This is the basis for the use-cases we’ll review.</p>

<p><br /><br /></p>
<h2 id="part-1-error-reporting-design">Part-1: Error reporting design</h2>

<p>Consider the following:</p>

<p>An Ad-Server gets a request for an advertisement from a mobile phone.</p>

<p>We’ll discuss a solution for executing the actions that need to be taken when the Ad-Server encounters errors. There are two types of error which should be handled appropriately as follows:</p>

<p>On <strong>FatalError</strong>:</p>

<ol>
  <li>
    <p>The Logger <em>prints</em> to the Log</p>
  </li>
  <li>
    <p>The Monitor <em>increments</em> the counter Metric.</p>
  </li>
  <li>
    <p>Kafka-Producer <em>sends</em> a Json Event with a timestamp  to Kafka.</p>
  </li>
  <li>
    <p><em>when step 3 failed</em>, S3-Client <em>uploads</em> the Event as CSV with a timestamp to to S3 (backup)</p>
  </li>
</ol>

<p>On <strong>InvalidRequestError</strong></p>

<ol>
  <li>
    <p>The Logger <em>prints</em> to the Log</p>
  </li>
  <li>
    <p>The Monitor <em>increments</em> the counter Metric.</p>
  </li>
  <li>
    <p>Kafka-Producer <em>sends</em> a Json Event to Kafka.</p>
  </li>
</ol>

<p><img src="/img/stackable_narrative.png" /></p>

<p>An Error has a code, a description, and unique properties</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">trait</span> <span class="nc">ServingError</span><span class="o">{</span>
 <span class="k">val</span> <span class="n">code</span><span class="k">:</span> <span class="kt">Int</span>
 <span class="k">val</span> <span class="n">description</span><span class="k">:</span> <span class="kt">String</span>
<span class="o">}</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">FatalError</span><span class="o">(</span><span class="k">override</span> <span class="k">val</span> <span class="n">code</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">exceptionCause</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">ServingError</span> <span class="o">{</span>
 <span class="k">override</span> <span class="k">val</span> <span class="n">description</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span>  <span class="n">s</span><span class="s">"Fatal Error code $code accrued"</span>
<span class="o">}</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">InvalidRequestError</span><span class="o">(</span><span class="n">paramName</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">paramValue</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="k">override</span> <span class="k">val</span> <span class="n">code</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">2</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">ServingError</span><span class="o">{</span>
 <span class="k">override</span> <span class="k">val</span> <span class="n">description</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">s</span><span class="s">"Invalid Request. Bad  parameter: $paramName"</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> <span class="n">s</span><span class="s">"with value: $paramValue"</span>
<span class="o">}</span>
</code></pre></div></div>
<p>And these are mocks for the Scala Clients</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">object</span> <span class="nc">KafkaProducer</span><span class="o">{</span>
 <span class="k">def</span> <span class="n">send</span><span class="o">(</span><span class="n">eventContent</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="n">println</span><span class="o">(</span><span class="n">s</span><span class="s">"sending to Kafka: $eventContent"</span><span class="o">)</span>
<span class="o">}</span>
<span class="k">object</span> <span class="nc">Monitor</span><span class="o">{</span>
 <span class="k">def</span> <span class="n">incrementCounter</span><span class="o">(</span><span class="n">counterName</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">tags</span><span class="k">:</span> <span class="o">(</span><span class="kt">String</span><span class="o">,</span> <span class="kt">String</span><span class="o">))</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="n">println</span><span class="o">(</span><span class="n">s</span><span class="s">"incrementing counter $counterName"</span><span class="o">)</span>
<span class="o">}</span>
<span class="k">object</span> <span class="nc">Logger</span><span class="o">{</span>
 <span class="k">def</span> <span class="n">log</span><span class="o">(</span><span class="n">event</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="n">println</span><span class="o">(</span><span class="n">s</span><span class="s">"error: $event"</span><span class="o">)</span>
<span class="o">}</span>
<span class="k">object</span> <span class="nc">S3_Client</span> <span class="o">{</span>
 <span class="k">def</span> <span class="n">upload</span><span class="o">(</span><span class="n">eventContent</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="n">println</span><span class="o">(</span><span class="n">s</span><span class="s">"uploading event $eventContent to S3"</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<p><br /><br /></p>
<h3 id="step-by-step-implementation-using-stackable-traits"><strong>Step-by-step implementation, using stackable-traits</strong></h3>

<h5 id="create-traits-that-represent-the-subscribers-and-mix-them">Create traits that represent the subscribers and mix them.</h5>

<p>We’ll create the following traits, each represents a subscriber for an error event</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">trait</span> <span class="nc">Log</span>
<span class="k">trait</span> <span class="nc">Metric</span>
<span class="k">trait</span> <span class="nc">S3_Backup</span>
<span class="k">trait</span> <span class="nc">Kafka</span>
</code></pre></div></div>

<p>And mix them with the ‘Error’ classes. Here, we use a Scala-type system to describe the ‘Error’ classes and the actions that need to be taken</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">trait</span> <span class="nc">ServingError</span><span class="o">{</span>
 <span class="k">val</span> <span class="n">code</span><span class="k">:</span> <span class="kt">Int</span>
 <span class="k">val</span> <span class="n">description</span><span class="k">:</span> <span class="kt">String</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="turn-the-traits-into-services-that-activates-the-clients">Turn the traits into services that activates the Clients</h5>

<p>Now it is clear which subscribers should receive a notification on error. We will enrich the traits, so they can activate the clients as well:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">abstract</span> <span class="k">class</span> <span class="nc">Sender</span> <span class="o">{</span>
 <span class="k">def</span> <span class="n">send</span><span class="o">(</span><span class="n">event</span><span class="k">:</span> <span class="kt">ServingError</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span>
<span class="o">}</span>
<span class="k">trait</span> <span class="nc">Log</span> <span class="k">extends</span> <span class="nc">Sender</span> <span class="o">{</span>
 <span class="k">override</span> <span class="k">def</span> <span class="n">send</span><span class="o">(</span><span class="n">event</span><span class="k">:</span> <span class="kt">ServingError</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
   <span class="nc">Logger</span><span class="o">.</span><span class="n">log</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="n">description</span><span class="o">)</span>
 <span class="o">}</span>
<span class="o">}</span>
<span class="k">trait</span> <span class="nc">Metric</span> <span class="k">extends</span> <span class="nc">Sender</span> <span class="o">{</span>
 <span class="k">override</span> <span class="k">def</span> <span class="n">send</span><span class="o">(</span><span class="n">event</span><span class="k">:</span> <span class="kt">ServingError</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
   <span class="nc">Monitor</span><span class="o">.</span><span class="n">incrementCounter</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="n">getClass</span><span class="o">.</span><span class="n">getSimpleName</span><span class="cm">/*this is not recommended...*/</span><span class="o">,</span> <span class="s">"errorCode"</span> <span class="o">-&gt;</span>
   <span class="n">event</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">toString</span><span class="o">)</span>
 <span class="o">}</span>
<span class="o">}</span>
<span class="k">trait</span> <span class="nc">S3_Backup</span> <span class="k">extends</span> <span class="nc">Sender</span> <span class="o">{</span>
 <span class="k">override</span> <span class="k">def</span> <span class="n">send</span><span class="o">(</span><span class="n">event</span><span class="k">:</span> <span class="kt">ServingError</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
   <span class="n">S3_Client</span><span class="o">.</span><span class="n">upload</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="n">content</span><span class="o">)</span>
 <span class="o">}</span>
<span class="o">}</span>
<span class="k">trait</span> <span class="nc">Kafka</span> <span class="k">extends</span> <span class="nc">Sender</span> <span class="o">{</span>
 <span class="k">def</span> <span class="n">send</span><span class="o">(</span><span class="n">event</span><span class="k">:</span> <span class="kt">ServingError</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
   <span class="nc">KafkaProducer</span><span class="o">.</span><span class="n">send</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="n">content</span><span class="o">)</span> <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Alright, so now each trait has a “send” method that handles the event using the appropriate client.
But we still need to trigger it on the occurrence of an error, and call them in the order described above</p>

<h5 id="stack-the-services-traits-with-each-other">‘Stack’ the services traits with each other</h5>

<p>In other words, a pipe of calls for the ‘send’ method in the services. As discussed, we’ll need to use super method calls for that.
Note that in this step we won’t be stacking modifications, but the side-effects that triggered an error.</p>

<p>Now we need to stack the traits according to the order and logic defined in the narrative described above. The order of the invocation of the traits will be right to left.</p>

<p>Hence the order for FatalError: S3_Backup ← Kafka ← Monitor ← Log
Where S3_Backup should be invoked only when the Kafka-Producer failed to send the event to Kafka.</p>

<p>And for InvalidRequestError: Kafka ← Monitor ← Log</p>

<p>Let’s re-arranged the mix of the ‘Error’ classes:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="k">class</span> <span class="nc">FatalError</span><span class="o">(</span><span class="k">override</span> <span class="k">val</span> <span class="n">code</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">exceptionCause</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">ServingError</span> <span class="k">with</span> <span class="n">S3_Backup</span> <span class="k">with</span> <span class="nc">Kafka</span> <span class="k">with</span> <span class="nc">Monitor</span> <span class="k">with</span> <span class="nc">Log</span><span class="o">{</span>
 <span class="k">override</span> <span class="k">val</span> <span class="n">description</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">s</span><span class="s">"Fatal Error code $code accrued"</span>
<span class="o">}</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">InvalidRequestError</span><span class="o">(</span><span class="n">paramName</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">paramValue</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="k">override</span> <span class="k">val</span> <span class="n">code</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">2</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">ServingError</span> <span class="k">with</span> <span class="nc">Kafka</span> <span class="k">with</span> <span class="nc">Monitoring</span> <span class="k">with</span> <span class="nc">Log</span><span class="o">{</span>
 <span class="k">override</span> <span class="k">val</span> <span class="n">description</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">s</span><span class="s">"Invalid Request. Bad  parameter: $paramName"</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> <span class="n">s</span><span class="s">"with value: $paramValue"</span>
<span class="o">}</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">FatalError</span><span class="o">(</span><span class="k">override</span> <span class="k">val</span> <span class="n">code</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">exceptionCause</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">ServingError</span> <span class="k">with</span> <span class="n">S3_Backup</span> <span class="k">with</span> <span class="nc">Kafka</span> <span class="k">with</span> <span class="nc">Monitor</span> <span class="k">with</span> <span class="nc">Log</span><span class="o">{</span>
 <span class="k">override</span> <span class="k">val</span> <span class="n">description</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">s</span><span class="s">"Fatal Error code $code accrued"</span>
<span class="o">}</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">InvalidRequestError</span><span class="o">(</span><span class="n">paramName</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">paramValue</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="k">override</span> <span class="k">val</span> <span class="n">code</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">2</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">ServingError</span> <span class="k">with</span> <span class="nc">Kafka</span> <span class="k">with</span> <span class="nc">Monitoring</span> <span class="k">with</span> <span class="nc">Log</span><span class="o">{</span>
 <span class="k">override</span> <span class="k">val</span> <span class="n">description</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">s</span><span class="s">"Invalid Request. Bad  parameter: $paramName"</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> <span class="n">s</span><span class="s">"with value: $paramValue"</span>
<span class="o">}</span>
</code></pre></div></div>

<p>And stack the traits:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">trait</span> <span class="nc">Log</span> <span class="k">extends</span> <span class="nc">Sender</span> <span class="o">{</span>
 <span class="k">abstract</span> <span class="k">override</span> <span class="k">def</span> <span class="n">send</span><span class="o">(</span><span class="n">event</span><span class="k">:</span> <span class="kt">ServingError</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
   <span class="nc">Logger</span><span class="o">.</span><span class="n">log</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="n">description</span><span class="o">)</span>
   <span class="k">super</span><span class="o">.</span><span class="n">send</span><span class="o">(</span><span class="n">event</span><span class="o">)</span>
 <span class="o">}</span>
<span class="o">}</span>
<span class="k">trait</span> <span class="nc">Metric</span> <span class="k">extends</span> <span class="nc">Sender</span> <span class="o">{</span>
 <span class="k">abstract</span> <span class="k">override</span> <span class="k">def</span> <span class="n">send</span><span class="o">(</span><span class="n">event</span><span class="k">:</span> <span class="kt">ServingError</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
   <span class="nc">Monitor</span><span class="o">.</span><span class="n">incrementCounter</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="n">getClass</span><span class="o">.</span><span class="n">getSimpleName</span><span class="o">,</span> <span class="s">"errorCode"</span> <span class="o">-&gt;</span> <span class="n">event</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">toString</span><span class="o">)</span>
   <span class="k">super</span><span class="o">.</span><span class="n">send</span><span class="o">(</span><span class="n">event</span><span class="o">)</span>
 <span class="o">}</span>
<span class="o">}</span>
<span class="k">trait</span> <span class="nc">S3_Backup</span> <span class="k">extends</span> <span class="nc">Sender</span> <span class="o">{</span>
 <span class="k">abstract</span> <span class="k">override</span> <span class="k">def</span> <span class="n">send</span><span class="o">(</span><span class="n">event</span><span class="k">:</span> <span class="kt">ServingError</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
   <span class="n">S3_Client</span><span class="o">.</span><span class="n">upload</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="n">content</span><span class="o">)</span>
   <span class="k">super</span><span class="o">.</span><span class="n">send</span><span class="o">(</span><span class="n">event</span><span class="o">)</span>
 <span class="o">}</span>
<span class="o">}</span>
<span class="k">trait</span> <span class="nc">Kafka</span> <span class="k">extends</span> <span class="nc">Sender</span> <span class="o">{</span>
 <span class="k">abstract</span> <span class="k">override</span> <span class="k">def</span> <span class="n">send</span><span class="o">(</span><span class="n">event</span><span class="k">:</span> <span class="kt">ServingError</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
   <span class="nc">Try</span><span class="o">(</span><span class="nc">KafkaProducer</span><span class="o">.</span><span class="n">send</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="n">content</span><span class="o">)).</span><span class="n">getOrElse</span><span class="o">(</span><span class="k">super</span><span class="o">.</span><span class="n">send</span><span class="o">(</span><span class="n">event</span><span class="o">))</span>
 <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>You might notice that</p>

<ol>
  <li>
    <p>The call ‘super.send(event)’ was added to ‘send’ method.</p>
  </li>
  <li>
    <p>The ‘override’ modifier changed to ‘abstract override’, because the send method now overrides the behavior, but also calls for an abstract method with super.send. The modifier indicates that this trait must be mixed with a concrete class(later…).</p>

    <p>By the way, if we omit the ‘abstract’ from the modifier, we’ll get the following error:
<em>“method send in class Sender is accessed from super. It may not be abstract unless it is overridden by a member declared ‘abstract’ and ‘override’ super.send(event)”</em></p>
  </li>
  <li>
    <p>Kafka would call super, i.e. S3-Backup would be invoked only when KafkaProducer fails to deliver.</p>
  </li>
</ol>

<h5 id="create-and-stack-modification-traits">Create and ‘Stack’ modification traits:</h5>

<p><img src="/img/stack-traits.jpg" height="300" /></p>

<p>The event content needs modification to be in the right format (json, csv) before being sent as an input to KafkaProducer and S3. A fatal error needs to be sent with a timestamp.</p>

<p>Let’s write the modification method and the stackable modification traits:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">object</span> <span class="nc">ServingError</span><span class="o">{</span>
<span class="c1">// we are adding a method modification content method, to be used by the modification traits
</span> <span class="k">def</span> <span class="n">modifyContent</span><span class="o">(</span><span class="n">error</span><span class="k">:</span> <span class="kt">ServingError</span><span class="o">,</span> <span class="n">content</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">ServingError</span> <span class="o">=</span> <span class="o">{</span>
   <span class="n">error</span> <span class="k">match</span> <span class="o">{</span>
     <span class="k">case</span> <span class="n">f</span><span class="k">:</span> <span class="kt">FatalError</span> <span class="o">=&gt;</span> <span class="nc">FatalError</span><span class="o">(</span><span class="n">exceptionCause</span> <span class="k">=</span> <span class="n">f</span><span class="o">.</span><span class="n">exceptionCause</span><span class="o">,</span> <span class="n">content</span> <span class="k">=</span> <span class="n">content</span><span class="o">)</span>
     <span class="k">case</span> <span class="n">i</span><span class="k">:</span> <span class="kt">InvalidRequestError</span> <span class="o">=&gt;</span> <span class="nc">InvalidRequestError</span><span class="o">(</span><span class="n">i</span><span class="o">.</span><span class="n">paramName</span><span class="o">,</span> <span class="n">i</span><span class="o">.</span><span class="n">paramValue</span><span class="o">,</span> <span class="n">content</span> <span class="k">=</span> <span class="n">content</span><span class="o">)</span>
   <span class="o">}</span>
 <span class="o">}</span>
<span class="o">}</span>

<span class="k">trait</span> <span class="nc">JsonTransformer</span> <span class="k">extends</span> <span class="nc">Sender</span> <span class="o">{</span>
 <span class="k">import</span> <span class="nn">ServingError._</span>
 <span class="k">abstract</span> <span class="k">override</span> <span class="k">def</span> <span class="n">send</span><span class="o">(</span><span class="n">event</span><span class="k">:</span> <span class="kt">ServingError</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
   <span class="k">super</span><span class="o">.</span><span class="n">send</span><span class="o">(</span><span class="n">modifyContent</span><span class="o">(</span><span class="n">event</span><span class="o">,</span> <span class="o">{</span>
     <span class="k">val</span> <span class="n">date</span> <span class="k">=</span> <span class="n">event</span> <span class="k">match</span> <span class="o">{</span>
       <span class="k">case</span> <span class="n">d</span><span class="k">:</span> <span class="kt">DateTimestampedMessage</span> <span class="o">=&gt;</span> <span class="s">"\"date\":"</span> <span class="o">+</span> <span class="n">d</span><span class="o">.</span><span class="n">date</span>
       <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="s">""</span>
     <span class="o">}</span>
     <span class="k">val</span> <span class="n">cause</span> <span class="k">=</span> <span class="n">event</span> <span class="k">match</span> <span class="o">{</span>
       <span class="k">case</span> <span class="n">f</span><span class="k">:</span> <span class="kt">FatalError</span> <span class="o">=&gt;</span> <span class="s">"\"cause\":"</span> <span class="o">+</span> <span class="n">f</span><span class="o">.</span><span class="n">exceptionCause</span>
       <span class="k">case</span> <span class="n">i</span><span class="k">:</span> <span class="kt">InvalidRequestError</span> <span class="o">=&gt;</span> <span class="s">"\"cause\":"</span> <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">paramName</span> <span class="o">+</span><span class="s">":"</span> <span class="o">+</span><span class="n">i</span><span class="o">.</span><span class="n">paramValue</span>
     <span class="o">}</span>
     <span class="n">s</span><span class="s">"""
             {
                "code:"${event.code},
                $date
                $cause
             }
      """</span>
   <span class="o">}))</span>
 <span class="o">}</span>
<span class="o">}</span>
<span class="k">trait</span> <span class="nc">CsVTransformer</span> <span class="k">extends</span> <span class="nc">Sender</span> <span class="o">{</span>
 <span class="k">import</span> <span class="nn">ServingError._</span>
 <span class="k">abstract</span> <span class="k">override</span> <span class="k">def</span> <span class="n">send</span><span class="o">(</span><span class="n">event</span><span class="k">:</span> <span class="kt">ServingError</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
   <span class="k">super</span><span class="o">.</span><span class="n">send</span><span class="o">(</span><span class="n">modifyContent</span><span class="o">(</span><span class="n">event</span><span class="o">,</span> <span class="o">{</span>
     <span class="k">val</span> <span class="n">date</span> <span class="k">=</span> <span class="n">event</span> <span class="k">match</span> <span class="o">{</span>
       <span class="k">case</span> <span class="n">d</span><span class="k">:</span> <span class="kt">DateTimestampedMessage</span> <span class="o">=&gt;</span> <span class="n">d</span><span class="o">.</span><span class="n">date</span>
       <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="s">""</span>
     <span class="o">}</span>
     <span class="k">val</span> <span class="n">cause</span> <span class="k">=</span> <span class="n">event</span> <span class="k">match</span> <span class="o">{</span>
       <span class="k">case</span> <span class="n">f</span><span class="k">:</span> <span class="kt">FatalError</span> <span class="o">=&gt;</span> <span class="n">f</span><span class="o">.</span><span class="n">exceptionCause</span>
       <span class="k">case</span> <span class="n">i</span><span class="k">:</span> <span class="kt">InvalidRequestError</span> <span class="o">=&gt;</span> <span class="n">i</span><span class="o">.</span><span class="n">paramName</span> <span class="o">+</span><span class="s">","</span> <span class="o">+</span><span class="n">i</span><span class="o">.</span><span class="n">paramValue</span>
     <span class="o">}</span>
     <span class="n">s</span><span class="s">"""${event.code},$date$cause"""</span>
   <span class="o">}))</span>
 <span class="o">}</span>
<span class="o">}</span>

<span class="k">trait</span> <span class="nc">Timestamp</span> <span class="o">{</span>
 <span class="k">val</span> <span class="n">date</span><span class="k">:</span> <span class="kt">Date</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Date</span><span class="o">()</span>
<span class="o">}</span>
</code></pre></div></div>

<p>And mix the modification traits to the ‘Error’ classes</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="k">class</span> <span class="nc">FatalError</span><span class="o">(</span><span class="k">override</span> <span class="k">val</span> <span class="n">code</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">exceptionCause</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">content</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">""</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">ServingError</span> <span class="k">with</span> <span class="n">S3_Backup</span> <span class="k">with</span> <span class="nc">CsVTransformer</span> <span class="k">with</span> <span class="nc">Kafka</span> <span class="k">with</span> <span class="nc">JsonTransformer</span> <span class="k">with</span> <span class="nc">Timestamp</span> <span class="k">with</span> <span class="nc">Metric</span> <span class="k">with</span> <span class="nc">Log</span><span class="o">{</span>
 <span class="k">override</span> <span class="k">val</span> <span class="n">description</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">s</span><span class="s">"Fatal Error code $code accrued"</span>
<span class="o">}</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">InvalidRequestError</span><span class="o">(</span><span class="n">paramName</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">paramValue</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="k">override</span> <span class="k">val</span> <span class="n">code</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">2</span><span class="o">,</span> <span class="n">content</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">""</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">ServingError</span> <span class="k">with</span> <span class="nc">Kafka</span> <span class="k">with</span> <span class="nc">JsonTransformer</span> <span class="k">with</span> <span class="nc">Log</span><span class="o">{</span>
 <span class="k">override</span> <span class="k">val</span> <span class="n">description</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">s</span><span class="s">"Invalid Request. Bad  parameter: $paramName"</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> <span class="n">s</span><span class="s">"with value: $paramValue"</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="create-and-mix-servingerrorsender-">Create and mix ‘ServingErrorSender’ :</h5>

<p>Last, to trigger error reports once an error object is created, we’ll mix them with a sending trait.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">trait</span> <span class="nc">ServingErrorSender</span> <span class="k">extends</span> <span class="nc">Sender</span><span class="o">{</span>
 <span class="k">this:</span> <span class="kt">ServingError</span> <span class="o">=&gt;</span>   <span class="c1">// force to be mixed with a ServingError class, (look for 'see cake-pattern')
</span> <span class="k">def</span> <span class="n">send</span><span class="o">()</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="n">send</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
 <span class="k">override</span> <span class="k">def</span> <span class="n">send</span><span class="o">(</span><span class="n">event</span><span class="k">:</span> <span class="kt">ServingError</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="s">""</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">trait</span> <span class="nc">ServingError</span> <span class="k">extends</span> <span class="nc">ServingErrorSender</span><span class="o">{</span>
 <span class="k">val</span> <span class="n">code</span><span class="k">:</span> <span class="kt">Int</span>
 <span class="k">val</span> <span class="n">description</span><span class="k">:</span> <span class="kt">String</span>
 <span class="k">val</span> <span class="n">content</span><span class="k">:</span> <span class="kt">String</span>
<span class="o">}</span>
</code></pre></div></div>

<p><br /><br /></p>
<h3 id="try-it-out"><strong>Try it out</strong></h3>

<p>We have completed the task!</p>

<p>Now, when invoking a ‘send’’ for an error, like the following:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">FatalError</span><span class="o">(</span><span class="n">exceptionCause</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">IllegalArgumentException</span><span class="o">().</span><span class="n">getClass</span><span class="o">.</span><span class="n">getSimpleName</span><span class="o">).</span><span class="n">send</span><span class="o">()</span>
</code></pre></div></div>

<p>Results are with the following printed to the log:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>error: Fatal Error code 1 accrued //Log
incrementing counter FatalError // Metric
sending to Kafka:  // Kafka
{
  "code:"1,
  "date":Thu Nov 30 16:56:33 IST 2017
  "cause":IllegalArgumentException
}
</code></pre></div></div>

<p><br /><br /></p>
<h3 id="next"><strong>Next</strong></h3>

<p>In <a href="https://fullgc.github.io/stackable-traits-pattern---part-2/">part-2</a> we’ll use stackable-actor traits for gathering actor’s metrics.</p>

<p><br /><br /></p>
<h3 id="references"><strong>References</strong></h3>

<p><em><a href="https://www.artima.com/shop/programming_in_scala_3ed">Programming in Scala(chapter 12.5) / Martin Odersky and co</a></em></p>

<hr />

<p><em>The complete source code and more running examples can be found in my <a href="https://github.com/FullGC/stackable-traits">github</a></em>.</p>

<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
var disqus_config = function () {
this.page.url = "https://fullgc.github.io/stackable-traits-pattern/"
this.page.identifier = stackable-1
};
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://FullGC.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>

<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


              <hr>

              <div class="container">
    <div class="row ">
        <div class="col-xs-2"></div>
        <div class="col-xs-8">
        <!-- Google + -->
        <div class="g-plus" data-action="share" data-annotation="bubble"></div>
        <script src="https://apis.google.com/js/platform.js" async defer></script>

        <!-- Facebook -->
        <div class="fb-share-button" data-href="http://fullgc.github.io/stackable-traits-pattern/" data-layout="button_count" style="position: relative; top: -8px; left: 33px;"></div>
        <div id="fb-root"></div>
        <script>(function(d, s, id) {
          var js, fjs = d.getElementsByTagName(s)[0];
          if (d.getElementById(id)) return;
          js = d.createElement(s); js.id = id;
          js.src = "//connect.facebook.net/fr_FR/sdk.js#xfbml=1&appId=609039549219229&version=v2.0";
          fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));</script>

    </div>
    </div>
    <div class="col-xs-2"></div>
</div>

            </div>
        </div>
    </div>
</article>
<br>

<script type="text/javascript" src="https://platform.linkedin.com/badges/js/profile.js" async defer></script>
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/clean-blog.js "></script>

    <div class="wrapper-footer">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <ul class="list-inline text-center">
                        <li>
                            <a href="https://www.linkedin.com/in/dani-shemesh">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                            </span>
                            </a>
                        </li>
                        
                        <li>

                            <a href="https://github.com/FullGC">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                            </a>
                        </li>
                        
                    </ul>
                    <p style="text-align: center;" class="copyright text-muted">Copyright &copy; FullGC 2019</p>
                </div>
            </div>
        </div>
        <div class="container">
            <footer class="footer">
                
<a href="mailto:dani.shemesh@hotmail.com"><i class="svg-icon email"></i></a>
<a href="https://www.facebook.com/dani.shemesh.397"><i class="svg-icon facebook"></i></a>

<a href="https://github.com/FullGC"><i class="svg-icon github"></i></a>

<a href="https://www.linkedin.com/in/dani-shemesh"><i class="svg-icon linkedin"></i></a>






            </footer>
        </div>

    </div>
</body>
</html>

