<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="A blog about backend development, Scala, Java and devOps">

    <title>Manage development and delivery workflow with jGit-flow and Jenkins-Pipeline - Part 3 | Dani</title>

    <link rel="canonical" href="http://fullgc.github.io/manage-development-and-delivery-workflow-with-jgit-flow-and-jenkins-pipeline-part-3/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- facebook Open Graph Metadatas -->
    <meta content="609039549219229" property="fb:app_id">
    <meta content="FullGC" property="og:site_name">
    
      <meta content="Manage development and delivery workflow with jGit-flow and Jenkins-Pipeline - Part 3" property="og:title">
    
    
      <meta content="article" property="og:type">
    
    
      <meta content="A blog about backend development, Scala, Java and devOps" property="og:description">
    
    
      <meta content="http://fullgc.github.io/manage-development-and-delivery-workflow-with-jgit-flow-and-jenkins-pipeline-part-3/" property="og:url">
    
    
      <meta content="2018-09-11T17:15:45+03:00" property="article:published_time">
      <meta content="http://fullgc.github.io/about/" property="article:author">
    
    
      <meta content="http://fullgc.github.io/img/workflow-main.jpg" property="og:image">
    
    
      
    
    
      
      <meta content="jira" property="article:tag">
      
      <meta content="jenkins" property="article:tag">
      
      <meta content="pipeline" property="article:tag">
      
      <meta content="ci/cd" property="article:tag">
      
      <meta content="release" property="article:tag">
      
      <meta content="deployment" property="article:tag">
      
    


    
      <meta name="twitter:url" content="http://fullgc.github.io/manage-development-and-delivery-workflow-with-jgit-flow-and-jenkins-pipeline-part-3/">
    
    
      <meta name="twitter:description" content="A blog about backend development, Scala, Java and devOps">
    
    
      <meta name="twitter:image:src" content="http://fullgc.github.io/img/workflow-main.jpg">
    

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-57009102-1', 'auto');
  ga('send', 'pageview');

</script>

</head>

<!-- Begin Jekyll SEO tag v2.3.0 -->
<title>Manage development and delivery workflow with jGit-flow and Jenkins-Pipeline - Part 3 | FullGC</title>
<meta property="og:title" content="Manage development and delivery workflow with jGit-flow and Jenkins-Pipeline - Part 3" />
<meta name="author" content="Dani Shemesh" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="This post is the third of a three parts series of articles about manage development and CI/CD workflow with jgit-flow and Pipeline" />
<meta property="og:description" content="This post is the third of a three parts series of articles about manage development and CI/CD workflow with jgit-flow and Pipeline" />
<link rel="canonical" href="http://fullgc.github.io/manage-development-and-delivery-workflow-with-jgit-flow-and-jenkins-pipeline-part-3/" />
<meta property="og:url" content="http://fullgc.github.io/manage-development-and-delivery-workflow-with-jgit-flow-and-jenkins-pipeline-part-3/" />
<meta property="og:site_name" content="FullGC" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-09-11T17:15:45+03:00" />
<script type="application/ld+json">
{"name":null,"description":"This post is the third of a three parts series of articles about manage development and CI/CD workflow with jgit-flow and Pipeline","author":{"@type":"Person","name":"Dani Shemesh"},"@type":"BlogPosting","url":"http://fullgc.github.io/manage-development-and-delivery-workflow-with-jgit-flow-and-jenkins-pipeline-part-3/","publisher":null,"image":null,"headline":"Manage development and delivery workflow with jGit-flow and Jenkins-Pipeline - Part 3","dateModified":"2018-09-11T17:15:45+03:00","datePublished":"2018-09-11T17:15:45+03:00","sameAs":null,"mainEntityOfPage":{"@type":"WebPage","@id":"http://fullgc.github.io/manage-development-and-delivery-workflow-with-jgit-flow-and-jenkins-pipeline-part-3/"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

<body>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a style="text-shadow:none" class="navbar-brand" href="/">Dani Shemesh</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                
                <li>
                    <a href="/about/">About</a>
                </li>
                
                <li>
                    <a href="/contact/">Contact</a>
                </li>
                
                <li>
                    
                </li>
                
                <li>
                    
                </li>
                
                <li>
                    
                </li>
                
                <li>
                    
                </li>
                
                <li>
                    
                </li>
                
                <li>
                    
                </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>

    <!-- /.container -->
</nav>

    <!-- Post Header -->
<header class="intro-header" style="background-image: url('/img/workflow-main.jpg')">
    <div class="container">
        <div class="row">

            <div class="col-lg-10 col-lg-offset-1 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>Manage development and delivery workflow with jGit-flow and Jenkins-Pipeline - Part 3</h1>
                    
                    <span class="meta">Posted by Dani Shemesh on September 11, 2018</span>
                </div>
            </div>
        </div>
    </div>
    <!-- Begin Jekyll SEO tag v2.3.0 -->
<title>Manage development and delivery workflow with jGit-flow and Jenkins-Pipeline - Part 3 | FullGC</title>
<meta property="og:title" content="Manage development and delivery workflow with jGit-flow and Jenkins-Pipeline - Part 3" />
<meta name="author" content="Dani Shemesh" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="This post is the third of a three parts series of articles about manage development and CI/CD workflow with jgit-flow and Pipeline" />
<meta property="og:description" content="This post is the third of a three parts series of articles about manage development and CI/CD workflow with jgit-flow and Pipeline" />
<link rel="canonical" href="http://fullgc.github.io/manage-development-and-delivery-workflow-with-jgit-flow-and-jenkins-pipeline-part-3/" />
<meta property="og:url" content="http://fullgc.github.io/manage-development-and-delivery-workflow-with-jgit-flow-and-jenkins-pipeline-part-3/" />
<meta property="og:site_name" content="FullGC" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-09-11T17:15:45+03:00" />
<script type="application/ld+json">
{"name":null,"description":"This post is the third of a three parts series of articles about manage development and CI/CD workflow with jgit-flow and Pipeline","author":{"@type":"Person","name":"Dani Shemesh"},"@type":"BlogPosting","url":"http://fullgc.github.io/manage-development-and-delivery-workflow-with-jgit-flow-and-jenkins-pipeline-part-3/","publisher":null,"image":null,"headline":"Manage development and delivery workflow with jGit-flow and Jenkins-Pipeline - Part 3","dateModified":"2018-09-11T17:15:45+03:00","datePublished":"2018-09-11T17:15:45+03:00","sameAs":null,"mainEntityOfPage":{"@type":"WebPage","@id":"http://fullgc.github.io/manage-development-and-delivery-workflow-with-jgit-flow-and-jenkins-pipeline-part-3/"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</header>


<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <div class="col-lg-10 col-lg-offset-1 col-md-10 col-md-offset-1">

				      <p><i>This post is the third of a three parts series of articles about manage development and CI/CD workflow with jgit-flow and Pipeline</i></p>

<ul>
  <li><a href="https://fullgc.github.io/manage-development-and-delivery-workflow-with-jgit-flow-and-jenkins-pipeline-part-1">Part-1: Tools and Planning</a></li>
  <li><a href="https://fullgc.github.io/manage-development-and-delivery-workflow-with-jgit-flow-and-jenkins-pipeline-part-2">Part-2: Git workflow with JGit-Flow</a></li>
  <li><a href="https://fullgc.github.io/manage-development-and-delivery-workflow-with-jgit-flow-and-jenkins-pipeline-part-3">Part-3: Development and delivery process with Jenkins Pipeline</a></li>
</ul>

<hr />

<h2 id="part-3-development-and-delivery-process-with-jenkins-pipeline">Part 3: Development and delivery process with Jenkins Pipeline</h2>

<p>The <a href="https://wiki.jenkins-ci.org/display/JENKINS/Pipeline+Plugin">Pipeline plugin</a>, allows users to implement a project’s entire build/test/deploy pipeline in a Jenkinsfile and stores that alongside their code.</p>

<p>Before we’ll begin writing the Jenkinsfile, keep in mind that there are many ways to implement a CI/CD process. The flow we’ll discuss and implement is just one approach.
Moreover, there are usually multiple ways of writing a command in the Jenkinsfile: Native Groovy (Pipeline plugin DSL is groovy based), use a shell script, a Pipeline script code, external libraries, etc..</p>

<p><br /><br /></p>
<h3 id="multibranch-pipeline">Multibranch Pipeline</h3>

<p>In a <a href="https://jenkins.io/doc/book/pipeline/multibranch/">Multibranch Pipeline</a> project, Jenkins automatically discovers, manages and executes Pipelines for branches which contain a Jenkinsfile in source control (It is possible to write a Pipeline script directly in the job configuration though). It enables an implementation of different Jenkinsfiles for different branches. However, here we’re going to implement a single Jenkinsfile for multiple branches.</p>

<h4 id="configuration">Configuration</h4>

<p>The entire definition of the Pipeline would be written in the Jenkinsfile, except the following: In the ‘Branch Source’ we’ll declare the source control and repository that we’ll work with (this can also be done with code). In addition, we’ll set the branch discovery strategy to “All Branches”, meaning the job would start for every modification of the repository (i.e. for every push).</p>

<p>Then we’ll exclude the release and ‘hotfix’ branches (this will be explained later).</p>

<p><img src="http://fullgc.github.io/public/l8Up2rOYZomboTh06PZE0A_img_8.png" alt="image alt text" /></p>

<p><br /><br /></p>
<h3 id="writing-the-jenkinsfile-step-by-step">Writing the Jenkinsfile, step-by-step</h3>

<hr />

<h4 id="context">Context</h4>
<p>The Pipeline job should be run on a dedicated Jenkins slave, ‘server CICD’, hence the script would be written inside a node context:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">node</span><span class="p">(</span><span class="s1">'Server CICD) {

   }
</span></code></pre></div></div>

<hr />

<h4 id="checkout">Checkout</h4>
<p>This step checkouts code from source control. Scm is a special variable which instructs the checkout step to clone the specific revision which triggers this Pipeline run.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">stage</span><span class="p">(</span><span class="s1">'Checkout'</span><span class="p">)</span> <span class="p">{</span>
   <span class="nx">checkout</span><span class="p">([</span>
           <span class="nx">$class</span>           <span class="p">:</span> <span class="s1">'GitSCM'</span><span class="p">,</span>
           <span class="nx">branches</span>         <span class="p">:</span> <span class="nx">scm</span><span class="p">.</span><span class="nx">branches</span><span class="p">,</span>
           <span class="nx">extensions</span>       <span class="p">:</span> <span class="nx">scm</span><span class="p">.</span><span class="nx">extensions</span> <span class="o">+</span> <span class="p">[[</span><span class="nx">$class</span><span class="p">:</span> <span class="s1">'LocalBranch'</span><span class="p">,</span> <span class="nx">localBranch</span><span class="p">:</span> <span class="s1">''</span><span class="p">]],</span>
           <span class="nx">userRemoteConfigs</span><span class="p">:</span> <span class="nx">scm</span><span class="p">.</span><span class="nx">userRemoteConfigs</span>
   <span class="p">])</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h4 id="build">Build</h4>

<p>a. <strong>Maven build</strong>: We are using the maven build tool, and trigger a maven build with a shell command.
   We like to get a detailed report from Pipeline on a failure, including failed tests, links to them, and statistics. Moreover, we like the job status to become automatically ‘unstable’ if there were failed tests. These are provided by the <a href="https://wiki.jenkins.io/display/JENKINS/Pipeline+Maven+Plugin">Pipeline Maven plugin</a>, which wraps the maven build command.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">withMaven</span><span class="p">(</span><span class="nx">jdk</span><span class="p">:</span> <span class="s1">'JDK 8 update 66'</span><span class="p">,</span> <span class="nx">maven</span><span class="p">:</span> <span class="s1">'Maven 3.0.5'</span><span class="p">)</span> <span class="p">{</span>
           <span class="nx">sh</span> <span class="s2">"mvn -Dmaven.test.failure.ignore=true clean install -Dsetup-profile=automation"</span>
<span class="p">}</span>
</code></pre></div></div>

<p><img src="http://fullgc.github.io/public/l8Up2rOYZomboTh06PZE0A_img_9.png" alt="image alt text" /></p>

<p>b. <strong>Handle build exceptions</strong> and test failures:
 On maven build failure:</p>

<p>If Pipeline checked out a feature branch (triggered by a push to a branch which starts with ‘ST-‘  ),  a notification email should be sent to the feature owner only. We’ll use the <a href="https://wiki.jenkins.io/display/JENKINS/Mailer">Mailer plugin</a> for that.</p>

<p>Otherwise, we like an email notification to be sent to all server members, and a notification to the slack channel as well (<a href="https://jenkins.io/doc/pipeline/steps/slack/">Slack plugin</a>). This should include a list of the last Git commits with the committer name, so that we can get an idea of what code modification broke the build.</p>

<p>If an exception has been thrown during the build, we like to:</p>

<ol>
  <li>
    <p>Catch it</p>
  </li>
  <li>
    <p>Change the build status to ‘failure’</p>
  </li>
  <li>
    <p>Send the appropriate notifications</p>
  </li>
  <li>
    <p>Throw the exception</p>
  </li>
</ol>

<p>The final script for the build looks like this:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">String</span> <span class="nx">branch</span> <span class="o">=</span> <span class="nx">env</span><span class="p">.</span><span class="nx">BRANCH_NAME</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
<span class="nx">stage</span><span class="p">(</span><span class="s1">'Maven build'</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">//returns a set of git revisions with the name of the committer</span>
   <span class="p">@</span><span class="nd">NonCPS</span>
   <span class="nx">def</span> <span class="nx">commitList</span> <span class="o">=</span> <span class="p">{</span>
       <span class="nx">def</span> <span class="nx">changes</span> <span class="o">=</span> <span class="s2">""</span>
       <span class="nx">currentBuild</span><span class="p">.</span><span class="nx">changeSets</span><span class="p">.</span><span class="nx">each</span> <span class="p">{</span> <span class="kd">set</span> <span class="o">-&gt;</span>
           <span class="kd">set</span><span class="p">.</span><span class="nx">each</span> <span class="p">{</span> <span class="nx">entry</span> <span class="o">-&gt;</span>
               <span class="nx">changes</span> <span class="o">+=</span> <span class="s2">"${entry.commitId} - ${entry.msg} </span><span class="err">\</span><span class="s2">n by ${entry.author.fullName}</span><span class="err">\</span><span class="s2">n"</span>
           <span class="p">}</span>
       <span class="p">}</span>
       <span class="k">return</span> <span class="nx">changes</span>
   <span class="p">}</span>

   <span class="nx">def</span> <span class="nx">handleFailures</span> <span class="o">=</span> <span class="p">{</span>
       <span class="k">if</span> <span class="p">(</span><span class="nx">branch</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s2">"ST-"</span><span class="p">))</span> <span class="p">{</span>
           <span class="nx">step</span><span class="p">([</span><span class="na">$class</span><span class="p">:</span> <span class="s1">'Mailer'</span><span class="p">,</span> <span class="na">notifyEveryUnstableBuild</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">recipients</span><span class="p">:</span> <span class="nx">emailextrecipients</span><span class="p">([[</span><span class="na">$class</span><span class="p">:</span> <span class="s1">'RequesterRecipientProvider'</span><span class="p">]]),</span> <span class="na">sendToIndividuals</span><span class="p">:</span> <span class="kc">true</span><span class="p">])</span>
       <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
           <span class="nx">step</span><span class="p">(</span><span class="s1">'Send notification'</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">mail</span><span class="p">(</span><span class="na">to</span><span class="p">:</span> <span class="s1">'server@fullgc.com'</span><span class="p">,</span>
                       <span class="na">subject</span><span class="p">:</span> <span class="s2">"Maven build failed for branch: "</span> <span class="o">+</span> <span class="nx">env</span><span class="p">.</span><span class="nx">BRANCH_NAME</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span>
                       <span class="na">body</span><span class="p">:</span> <span class="s2">"last commits are: "</span> <span class="o">+</span> <span class="nx">commitList</span><span class="p">().</span><span class="nx">toString</span><span class="p">()</span> <span class="o">+</span> <span class="s2">" (&lt;$BUILD_URL/console|Job&gt;)"</span><span class="p">);</span>
           <span class="p">}</span>
           <span class="nx">slackSend</span> <span class="na">channel</span><span class="p">:</span> <span class="s1">'server'</span><span class="p">,</span> <span class="na">color</span><span class="p">:</span> <span class="s1">'warning'</span><span class="p">,</span> <span class="na">message</span><span class="p">:</span> <span class="s2">"Maven build failed for branch ${branch} </span><span class="se">\"</span><span class="s2">. </span><span class="err">\</span><span class="s2">nlast Commits are: </span><span class="err">\</span><span class="s2">n"</span> <span class="o">+</span> <span class="nx">commitList</span><span class="p">().</span><span class="nx">toString</span><span class="p">()</span> <span class="o">+</span> <span class="s2">"</span><span class="err">\</span><span class="s2">n (&lt;$BUILD_URL/console|Job&gt;)"</span>
       <span class="p">}</span>
   <span class="p">}</span>

   <span class="k">try</span> <span class="p">{</span>
       <span class="nx">withMaven</span><span class="p">(</span><span class="na">jdk</span><span class="p">:</span> <span class="s1">'JDK 8 update 66'</span><span class="p">,</span> <span class="na">maven</span><span class="p">:</span> <span class="s1">'Maven 3.0.5'</span><span class="p">)</span> <span class="p">{</span>
           <span class="nx">sh</span> <span class="s2">"mvn -Dmaven.test.failure.ignore=true clean install -Dsetup-profile=automation"</span>
       <span class="p">}</span>
       <span class="k">if</span> <span class="p">(</span><span class="nx">currentBuild</span><span class="p">.</span><span class="nx">result</span><span class="p">(</span><span class="s2">"UNSTABLE"</span><span class="p">))</span> <span class="p">{</span>
           <span class="nx">handleFailures</span><span class="p">()</span>
       <span class="p">}</span>
   <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
       <span class="nx">manager</span><span class="p">.</span><span class="nx">buildFailure</span><span class="p">()</span>
       <span class="nx">handleFailures</span><span class="p">()</span>
       <span class="k">throw</span> <span class="nx">e</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h4 id="release-process">Release process</h4>
<p><img align="right" src="/img/releasememe.png" height="110" width="230" />
In this process, we’ll upload a tar (the maven build output) to s3, where the environment depends on the git branch we’re working on. The code would be placed in the ‘process’ step:</p>

<p>a. <strong>Release tar name.</strong> The release file is a tar file (the maven build output). Its name should represent the release version. The release version is found in the root pom.xml file, and we’ll extract it from there</p>

<p>b. <strong>Release candidate tar name.</strong> This is somewhat tricky.
On <strong>release/hotfix</strong> only, we like to create a release candidate for QA.
The release candidate holds the name:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="nx">volcano</span> <span class="nx">version</span><span class="o">&gt;</span><span class="nx">RC</span><span class="o">-&lt;</span><span class="nx">RC</span> <span class="nx">number</span><span class="o">&gt;</span>
</code></pre></div></div>

<p>In our story, the first release candidate would be: ‘volcano-1.2.0-RC-1’(‘volcano-1.2.1-RC-1’ in the case of a hotfix).</p>

<p>The RC number starts with 1. If a QA person found a bug, we’d need to fix it, and then increment the RC number, i.e. ‘volcano-1.2.0-RC-2’ and so on.</p>

<p>We’ll use a text file with the current RC number to know what the next version should be for release. We then update the file, commit changes and create a new tart with the correct name.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">def</span> <span class="nx">pom</span> <span class="o">=</span> <span class="nx">readFile</span> <span class="s1">'pom.xml'</span>
<span class="nx">def</span> <span class="nx">project</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XmlSlurper</span><span class="p">().</span><span class="nx">parseText</span><span class="p">(</span><span class="nx">pom</span><span class="p">)</span>
<span class="nb">String</span> <span class="nx">version</span> <span class="o">=</span> <span class="nx">project</span><span class="p">.</span><span class="nx">version</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
<span class="nb">String</span> <span class="nx">tarName</span> <span class="o">=</span> <span class="s2">"volcano-${version}-release-pack.tar.gz"</span>

<span class="nx">stage</span><span class="p">(</span><span class="s1">'Release'</span><span class="p">){</span>

<span class="p">@</span><span class="nd">NonCPS</span>
<span class="nx">def</span> <span class="nx">newVersion</span> <span class="o">=</span> <span class="p">{</span>
   <span class="nx">def</span> <span class="nx">doesFileExist</span> <span class="o">=</span> <span class="nx">fileExists</span> <span class="s1">'releases.txt'</span>
   <span class="k">if</span> <span class="p">(</span><span class="nx">doesFileExist</span><span class="p">)</span> <span class="p">{</span>
       <span class="nx">echo</span> <span class="s2">"file releases.txt exists"</span>
       <span class="nx">def</span> <span class="nx">file</span> <span class="o">=</span> <span class="nx">readFile</span> <span class="s1">'releases.txt'</span>
       <span class="nb">String</span> <span class="nx">fileContents</span> <span class="o">=</span> <span class="nx">file</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
       <span class="nx">Integer</span> <span class="nx">newTarVersion</span> <span class="o">=</span> <span class="nx">fileContents</span><span class="p">.</span><span class="nx">toInteger</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
       <span class="nx">writeFile</span> <span class="na">file</span><span class="p">:</span> <span class="s1">'releases.txt'</span><span class="p">,</span> <span class="na">text</span><span class="p">:</span> <span class="nx">newTarVersion</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
       <span class="nx">echo</span> <span class="s2">"new tar version is: "</span> <span class="o">+</span> <span class="nx">newTarVersion</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
       <span class="nx">echo</span> <span class="s2">"file releases.txt does not exist"</span>
       <span class="nx">writeFile</span> <span class="na">file</span><span class="p">:</span> <span class="s1">'releases.txt'</span><span class="p">,</span> <span class="na">text</span><span class="p">:</span> <span class="s2">"1"</span>
   <span class="p">}</span>
   <span class="nx">readFile</span> <span class="s1">'releases.txt'</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">branch</span><span class="p">.</span><span class="nx">equals</span><span class="p">(</span><span class="s2">"release"</span><span class="p">)</span> <span class="o">||</span> <span class="nx">branch</span><span class="p">.</span><span class="nx">equals</span><span class="p">(</span><span class="s2">"hotfix"</span><span class="p">))</span> <span class="p">{</span>
   <span class="nb">String</span> <span class="nx">tarRCVersion</span> <span class="o">=</span> <span class="nx">newVersion</span><span class="p">()</span>
   <span class="nx">newTarName</span> <span class="o">=</span> <span class="s2">"volcano${version}-RC-${tarRCVersion}-release-pack.tar.gz"</span>
   <span class="nx">sh</span> <span class="s2">"mv ./volcano/target/${tarName} ./viper/target/${newTarName}"</span>
   <span class="nx">tarName</span> <span class="o">=</span> <span class="nx">newTarName</span>
<span class="p">}</span>
<span class="p">}</span>
<span class="nx">step</span><span class="p">(</span><span class="s1">'Commit and push releases file'</span><span class="p">)</span> <span class="p">{</span>
   <span class="nx">sh</span> <span class="s2">"git remote set-url origin git@bitbucket.org:fullgc/volcano.git"</span>
   <span class="nx">sh</span> <span class="s2">"git add -A"</span>
   <span class="nx">sh</span> <span class="s2">"git commit -m 'update volcano version to '${tarRCVersion}"</span>
   <span class="nx">sh</span> <span class="s2">"git push"</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Note that we did exclude the release/hotfix branches. This allows a couple of team members to work on the branch when QA has made a rejection or there is a bug to fix, without the new version being released with every push.</p>

<hr />

<h4 id="upload-tar-to-s3">Upload tar to s3</h4>
<p>We won’t implement the deployment process with the Pipeline script, and leave it for the deployment tool, ‘Chef’ for the sake of this illustration.
Chef will deploy a new volcano app, with the appropriate version in s3. This would require amazon s3 credentials.
For the upload itself, there is a pipeline script. Nevertheless, we’ll implement it here using
Amazon CLI commands, using the shell.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">step</span><span class="p">(</span><span class="s1">'Upload tar to s3 cli'</span><span class="p">)</span> <span class="p">{</span>
   <span class="nx">withCredentials</span><span class="p">([[</span><span class="nx">$class</span><span class="p">:</span> <span class="s1">'AmazonWebServicesCredentialsBinding'</span><span class="p">,</span> <span class="nx">credentialsId</span><span class="p">:</span> <span class="s1">'xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx'</span><span class="p">,</span> <span class="nx">accessKeyVariable</span><span class="p">:</span> <span class="s1">'AWS_ACCESS_KEY_ID'</span><span class="p">,</span> <span class="nx">secretKeyVariable</span><span class="p">:</span> <span class="s1">'AWS_SECRET_ACCESS_KEY'</span><span class="p">]])</span> <span class="p">{</span>
       <span class="nx">sh</span> <span class="s2">"pip install --user awscli"</span>
       <span class="nx">sh</span> <span class="s2">"sudo apt-get -y install awscli"</span>
       <span class="nx">sh</span> <span class="s2">"aws s3 cp ./volcano/target/${tarName} s3://fullgc/tars/"</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h4 id="deployment-process">Deployment process</h4>
<p>We won’t be diving too deeply into how Chef performs a deployment, but suffice to say this: In order for Chef to know that there is a new ‘volcano’ version it needs to deploy, the version in the <a href="https://docs.chef.io/environments.html">environment</a> (qa or development or production) file needs to be updated to the new version.</p>

<p>a. First, we’ll check out the Chef repository and ‘cd’  in the environments directory which the environment files rely on.</p>

<p>b. Replace the current version of the appropriate environment for the new version. This can be done by shell tools like jq. Here we’ll use Groovy.</p>

<p>c. Commit and push changes</p>

<p>d. Send a slack notification</p>

<p>e. If the branch is develop or master, it removes the releases.txt file</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">branch</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">'ST-'</span><span class="p">)){</span>
  <span class="nx">stage</span><span class="p">(</span><span class="s1">'Deploy'</span><span class="p">)</span> <span class="p">{</span>

  <span class="nx">def</span> <span class="nx">incrementVersion</span> <span class="o">=</span> <span class="p">{</span>
     <span class="nx">def</span> <span class="nx">environment</span> <span class="o">=</span> <span class="p">{</span>
     <span class="k">switch</span><span class="p">(</span><span class="nx">branch</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">case</span> <span class="s1">'develop'</span><span class="p">:</span> <span class="s1">'development.json'</span>
             <span class="k">break</span>
         <span class="k">case</span> <span class="s1">'master'</span><span class="p">:</span> <span class="s1">'production.json'</span>
             <span class="k">break</span>
         <span class="na">default</span><span class="p">:</span> <span class="s1">'qa.json'</span>
     <span class="p">}</span>
  <span class="p">}</span>
   <span class="nx">def</span> <span class="nx">environmentFileContent</span> <span class="o">=</span> <span class="nx">readFile</span> <span class="nx">environment</span>
   <span class="nx">def</span> <span class="nx">environmentJson</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">groovy</span><span class="p">.</span><span class="nx">json</span><span class="p">.</span><span class="nx">JsonSlurper</span><span class="p">().</span><span class="nx">parseText</span><span class="p">(</span><span class="nx">environmentFileContent</span><span class="p">)</span>
   <span class="nx">environmentJson</span><span class="p">.</span><span class="nx">default_attributes</span><span class="p">.</span><span class="nx">volcano</span><span class="p">.</span><span class="nx">version</span> <span class="o">=</span> <span class="s2">"volcano-${version}"</span>
   <span class="nb">String</span> <span class="nx">environmentPrettyJsonString</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">groovy</span><span class="p">.</span><span class="nx">json</span><span class="p">.</span><span class="nx">JsonBuilder</span><span class="p">(</span><span class="nx">environmentJson</span><span class="p">).</span><span class="nx">toPrettyString</span><span class="p">()</span>
   <span class="nx">environmentJson</span> <span class="o">=</span> <span class="kc">null</span>
   <span class="nx">writeFile</span> <span class="na">file</span><span class="p">:</span> <span class="nx">$environment</span><span class="p">,</span> <span class="na">text</span><span class="p">:</span> <span class="nx">environmentPrettyJsonString</span>

  <span class="nx">sh</span> <span class="s2">"git commit -am 'Changed volcano version in $environment env to '${version}"</span>
  <span class="nx">sh</span> <span class="s2">"git push"</span>
<span class="p">}</span>

<span class="nx">checkout</span> <span class="na">changelog</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span> <span class="na">poll</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span> <span class="na">scm</span><span class="p">:</span> <span class="p">[</span><span class="na">$class</span><span class="p">:</span> <span class="s1">'GitSCM'</span><span class="p">,</span> <span class="na">browser</span><span class="p">:</span> <span class="p">[</span><span class="na">$class</span><span class="p">:</span> <span class="s1">'BitbucketWeb'</span><span class="p">,</span> <span class="na">repoUrl</span><span class="p">:</span> <span class="s1">'https://bitbucket.org/fullgc/chef'</span><span class="p">],</span> <span class="na">doGenerateSubmoduleConfigurations</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span> <span class="na">extensions</span><span class="p">:</span> <span class="p">[[</span><span class="na">$class</span><span class="p">:</span> <span class="s1">'LocalBranch'</span><span class="p">,</span> <span class="na">localBranch</span><span class="p">:</span>
  <span class="s1">'**'</span><span class="p">]],</span> <span class="na">submoduleCfg</span><span class="p">:</span> <span class="p">[],</span> <span class="na">userRemoteConfigs</span><span class="p">:</span> <span class="p">[[</span><span class="na">url</span><span class="p">:</span> <span class="s1">'git@bitbucket.org:fullgc/chef'</span><span class="p">]]]</span>
   <span class="nx">dir</span><span class="p">(</span><span class="s1">'environments/'</span><span class="p">)</span> <span class="p">{</span>
       <span class="nx">incrementVersion</span><span class="p">()</span>
   <span class="p">}</span>
<span class="nx">slackSend</span> <span class="na">channel</span><span class="p">:</span> <span class="s1">'server'</span><span class="p">,</span> <span class="na">color</span><span class="p">:</span> <span class="s1">'good'</span><span class="p">,</span> <span class="na">message</span><span class="p">:</span> <span class="s2">" New volcano version ${version} is being deployed to $environment"</span>
  <span class="p">}</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">branch</span> <span class="o">==</span> <span class="s1">'develop'</span> <span class="o">||</span> <span class="nx">branch</span> <span class="o">==</span> <span class="s1">'master'</span><span class="p">)</span> <span class="nx">sh</span> <span class="s2">"rm releases.txt"</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In the image below an example of a Pipeline run:</p>

<p><img src="http://fullgc.github.io/public/l8Up2rOYZomboTh06PZE0A_img_10.png" alt="image alt text" /></p>

<p><br /><br /></p>
<h3 id="tips">Tips</h3>

<ul>
  <li>
    <p>To save a lot of time, use the <a href="https://jenkins-prod.inner-active.mobi/job/DevOps/job/Terraform/job/Clean_Validation/pipeline-syntax/">Pipeline Syntax</a> for every pipeline command</p>
  </li>
  <li>
    <p>While working on the Jenkinsfile, you don’t have to commit and push every modification just to test an execution. You can use run an execution using <a href="https://jenkins.io/doc/book/pipeline/development/#replay">‘replay’</a> until everything works.</p>
  </li>
  <li>
    <p><a href="https://jenkins.io/doc/book/blueocean/">Jenkins Blue Ocean</a> plugin provides a new awesome user experience, check it out.</p>
  </li>
  <li>
    <p>Pipeline is still new, but you shouldn’t get too frustrated by weird errors you may get while writing the script, most of them are common and the solution can be easily found on the web.</p>
  </li>
  <li>
    <p>The <a href="https://github.com/jenkinsci/JenkinsPipelineUnit/">Pipeline Unit Testing</a> Framework allows you to unit test Pipelines before running them in full.</p>
  </li>
</ul>

<p><br /><br /></p>
<h3 id="wrapping-up">Wrapping up</h3>

<p>Pipeline as a code is pretty much a game changer, in the sense that it is now in the hands of every programmer, allowing them to write a full release (and deployment) process, that can fit the development workflow easily.</p>

<hr />

<p><em>The complete code can be found in my <a href="https://github.com/FullGC/volcano_manage_cicd">GitHub</a></em>.</p>

<div id="disqus_thread"></div>
<script>
/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
var disqus_config = function () {
this.page.url = "https://fullgc.github.io/manage-development-and-delivery-workflow-with-jgit-flow-and-jenkins-pipeline-part-3/"
this.page.identifier = workflow-3
};
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://FullGC.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>

<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


              <hr>

              <div class="container">
    <div class="row ">
        <div class="col-xs-2"></div>
        <div class="col-xs-8">
        <!-- Google + -->
        <div class="g-plus" data-action="share" data-annotation="bubble"></div>
        <script src="https://apis.google.com/js/platform.js" async defer></script>

        <!-- Facebook -->
        <div class="fb-share-button" data-href="http://fullgc.github.io/manage-development-and-delivery-workflow-with-jgit-flow-and-jenkins-pipeline-part-3/" data-layout="button_count" style="position: relative; top: -8px; left: 33px;"></div>
        <div id="fb-root"></div>
        <script>(function(d, s, id) {
          var js, fjs = d.getElementsByTagName(s)[0];
          if (d.getElementById(id)) return;
          js = d.createElement(s); js.id = id;
          js.src = "//connect.facebook.net/fr_FR/sdk.js#xfbml=1&appId=609039549219229&version=v2.0";
          fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));</script>

    </div>
    </div>
    <div class="col-xs-2"></div>
</div>

            </div>
        </div>
    </div>
</article>
<br>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/clean-blog.js "></script>

    <div class="wrapper-footer">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <ul class="list-inline text-center">
                        <li>
                            <a href="https://www.linkedin.com/in/dani-shemesh">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                            </span>
                            </a>
                        </li>
                        
                        <li>

                            <a href="https://github.com/FullGC">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                            </a>
                        </li>
                        
                    </ul>
                    <p style="text-align: center;" class="copyright text-muted">Copyright &copy; FullGC 2018</p>
                </div>
            </div>
        </div>
        <div class="container">
            <footer class="footer">
                
<a href="mailto:dani.shemesh@hotmail.com"><i class="svg-icon email"></i></a>
<a href="https://www.facebook.com/dani.shemesh.397"><i class="svg-icon facebook"></i></a>

<a href="https://github.com/FullGC"><i class="svg-icon github"></i></a>

<a href="https://www.linkedin.com/in/dani-shemesh"><i class="svg-icon linkedin"></i></a>






            </footer>
        </div>

    </div>
</body>
</html>

